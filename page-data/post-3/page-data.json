{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/post-3/",
    "result": {"data":{"site":{"siteMetadata":{"title":"paerck25.logger"}},"markdownRemark":{"id":"25573c4d-a8ae-50cf-aa4b-4d2a5a341d04","excerpt":"저희 회사에는 실제로 운영하는 product 서버,\n내부에서 Q/A 하는 용도의 develop 서버가 있습니다.\n\n이슈나 개선사항 같은 것들을 개발하여 develop 서버에 배포 하고 Q/A를 마치고 product…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bb6b88c165cd0c941b33a5353a888d32/1cfc2/NGINX-logo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.69620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAByElEQVQoz6WSy08TURTG7z/hH2HYumJhSFh1I68VRtZGYAlSWIARymthE0ykJLwKUR4tQY0KscpzpnWgQTo8pu1QCLUDlWEKbQkM9N5zyMwwblxycxffOff7cm/O7xK8xyIMWAEoIjIABowBFIAWDMEAgQKjwIxTNPpmaZip6SSICEaSWQIA/r8BECyD5aG2JrwqjRz8QERBiwVPJVXPNmwO1214QqdROX/0WVn7pAg6u1EutcH97zOpUCD9GxHHDxfXNZn0SH7yvnThROyXv7ZERptEb/vO1Ewq6BS9347CTtFbxXUkL9UKrvPBbPVkcvXxQnPz1ljxz5eJi2PyemfyefhdjeCu4rvrNwaeBnsD6U1nxFvOuzyJuTexjzWC+wnX0RQZday8UvVs6/YHMvTIl1wxnt0YGemSfH/1czLh6JX8ffKXMs5VyXc+E9y+w+Xa9bcP516U8y5EdCy3te9OlSy1TCe5ovn6cGaPxHNKNJdCxDUtLmX/6OxmaD/gScynr85UPRvNpRZPxMx1HhDDGXlV3bXMv7RYPK+QuxnaQ2a2AHPfNRHArsBkCf84WxgoUIutyZmCGWAmWGYmLea22RDkPj/sFvGRQJ4mkbwlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"nginx\"\n        title=\"nginx\"\n        src=\"/static/bb6b88c165cd0c941b33a5353a888d32/f058b/NGINX-logo.png\"\n        srcset=\"/static/bb6b88c165cd0c941b33a5353a888d32/c26ae/NGINX-logo.png 158w,\n/static/bb6b88c165cd0c941b33a5353a888d32/6bdcf/NGINX-logo.png 315w,\n/static/bb6b88c165cd0c941b33a5353a888d32/f058b/NGINX-logo.png 630w,\n/static/bb6b88c165cd0c941b33a5353a888d32/1cfc2/NGINX-logo.png 900w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>저희 회사에는 실제로 운영하는 product 서버,<br>\n내부에서 Q/A 하는 용도의 develop 서버가 있습니다.<br>\n<br>\n이슈나 개선사항 같은 것들을 개발하여 develop 서버에 배포 하고 Q/A를 마치고 product서버에 배포하는 흐름으로 개발을 하고 있습니다.<br>\n처음 왔을 때 기존의 개발자분들이 배포를 직접 터미널에서 ssh로 서버에 접속해서 수동으로 하시고 있었습니다.<br>\n<br>\n그래서 제가 한번 develop 서버 배포를 자동화 시켜보겠습니다 하고 github action을 사용하여 develop 서버에 배포하는 과정을 간단하게 자동화를 하였습니다.<br>\ndevelop 서버는 docker 같은 것을 사용하지 않았고 반영사항을 pull하고 start만 해주면 되는 간단한 프로세스였기에 금방 할 수 있었습니다.<br>\n<br>\ndevelop 서버는 간단하게 구성하였지만 <br>\nproduct 서버는 배포할 때 2 ~ 3초의 서버 다운이 생기기 때문에 이걸 해결해 달라는 요구사항이 있어서 바로 자동화하진 못했고, 그렇게 어영부영 시간이 지나다 보니 이제서야 자동화를 해보려고 합니다.\n<br></p>\n<h2>nginx</h2>\n<p>무중단 배포를 구성하기 위해서 nginx의 로드밸런싱 기능을 사용하려고 합니다.<br></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7f26f1dc70fd786c08b2e3e3f35a7e2c/a242d/load-balancer.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACoklEQVQozx2S30tTYRjHvzvKSN0sNlNQlkRUXoSJafkDSqFwgZJDikgzmW7nx85qSw30qDuMBZq/ZpN54ZAW29XwRhg4jwxERER3MSWHLsRzEETwL+jmxLuLhxfe78v7/Tzf50E6nS7LZDK98Xi8GAAEQch3Op1gWRb9DjsMs61AsBGaYGPunO4eyWkMw8DlcqGtrQ2SJCESiZjC4XApTk9PO2VZVjc2NpoAUOPj43qGYXQDtE2jQkX1D4vmbqSLMqy0UYWLz3N3bpuTfJg/NjamA5AXCoWqLi8v1bOzsxkkk0nj3t7ewP7+vtbv98NqtcJutxcwfTbK88GNWv9bGFfMwPwjUP4GYPkx+pw2OBwO3cTExA1VVbG6unpfUZQ/six35QjPz88JYTMhFEVRT9O00e5ki4f6PxdavtsMeUvNUwjULWP+aQkkCvADHMcVer1euN1ukpRma2urJ5FI1GJ7e7s0lUoxa2trhcTN4/FQHMeV0IOOyiXziLEu8L6vWxLV1/Gv6oMli5At/1lkHWRMPM8bRVEsIhDRaLTm+vpaVRQliGw2264oyj9JkhqIE8mFYRiD1UXrQ++8BQ8n2+9VhDuS5b860lWBzvq9xoDW+o3V8zx/SxTFfAIRi8XKjo+PF9LpdD12d3dNR0dHQjwev0VEUjRNF7EfB6jfXT6Uzr3MtQQztLcXX0G9uQ3WxYPn+aLh4WEteT85OanLZDIzqVTqDcmwVZblv4lEooZMbHR0lBAW22g7Rc08Q+WsWYM7AByAfuEFFbNMgf9EkylrBUHQE7NIJFJ3dXWlXlxczOHw8LD65OQksrm5aSJuPp8vn2VZDcdx6P1iA5afAMEGUMEmYBoYo4fAsExuD1taWhCNRrG+vq47ODjo2dnZqfgPiocsw5IriksAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"load_balancer\"\n        title=\"load_balancer\"\n        src=\"/static/7f26f1dc70fd786c08b2e3e3f35a7e2c/f058b/load-balancer.png\"\n        srcset=\"/static/7f26f1dc70fd786c08b2e3e3f35a7e2c/c26ae/load-balancer.png 158w,\n/static/7f26f1dc70fd786c08b2e3e3f35a7e2c/6bdcf/load-balancer.png 315w,\n/static/7f26f1dc70fd786c08b2e3e3f35a7e2c/f058b/load-balancer.png 630w,\n/static/7f26f1dc70fd786c08b2e3e3f35a7e2c/a242d/load-balancer.png 724w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>로드밸런싱이란 외부에서 들어온 요청을 여러 개의 서버로 적절히 나누어서 처리하고, 하나의 서버가 다운이 되면 다른 온라인 서버로 요청을 리디렉션 하는 것이라고 합니다.<br>\n<br>\n위의 로드밸런싱을 활용하여 기존 서버를 유지한 채 신규 서버를 구성하여 두 개의 서버로 나눠서 요청을 받다가, 기존의 서버 인스턴스를 닫고 신규 서버로 모든 요청을 돌리는 방식으로 서버의 중단이 없는 배포 방식을 구성하려고 합니다.<br>\n<br>\nnginx에서 로드밸런싱을 하려면 설정을 해주어야 합니다.<br>\n가장 기본적인 설정 파일은 보통 etc/nginx/nginx.conf 파일이고<br>\nnginx.conf 파일에 모두 작성해도 되지만, 다른 .conf 파일을 만들고 inclue하여 사용할 수 있습니다.<br>\n<br>\n우선 기본적인 nginx.conf 파일을 보면</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// nginx.conf\n\nworker_processes  1;\n\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n    include       mime.types;\n    server {\n        listen       80;\n        location / {\n            root   html;\n            index  index.html index.htm;\n        }\n    }\n}</code></pre></div>\n<p>이런식으로 구성이 되어있습니다.<br>\n설정을 제 나름대로 풀어보면, <br>\n최대 사용자 수는 1 * 1024(worker_processes * worker_connections ) 이고,<br>\n서버의 80번 포트로 요청이 오면 index.html 파일을 서빙해준다. <br>\n인 것 같습니다. <br>\n<br>\n각각의 지시어에 대해서는 구글선생님이 친절하게 알려주시기 때문에..<br>\n아무튼, 저는 이 nginx.conf를 이런식으로 작성하였습니다<br>\n<br></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">worker_processes auto;\n\nevents {\n  worker_connections 1024;\n}\n\nhttp {\n  charset utf-8;\n  include mime.types;\n\n  include conf.d/*.conf;\n}</code></pre></div>\n<p>worker_processes는 서버의 코어 수 만큼 할당하는 것이 보통이지만 auto로 하여도 무방하다 하여 auto로 지정하였고,<br>\ncharset은 한국어 깨짐 문제를 방지하기 위해서 사용하였습니다. <br>\n<br>\n여기까지가 nginx의 기본 설정이고 그 외의 로드밸런싱 설정은 .conf 파일을 따로 만들어서 작성하였습니다.<br>\n위의 nginx.conf의 맨 아랫줄에 inclue하는 부분에서 아래의 mysite.conf 파일을 불러와서 적용시킵니다.\n<br></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// conf.d/mysite.conf\n\nupstream django-server {\n        server web:8000;\n        server web:8001;\n}\n\nserver {\n    listen 80;\n    server_name mysitedomain.com;\n    client_max_body_size 20M;\n\n    location / {\n        proxy_pass http://django-server;\n    }\n\n    location /static/ {\n            alias /code/static_root/;\n    }\n\n    location /media/ {\n            alias /code/media/;\n    }\n}\n</code></pre></div>\n<p>nginx의 로드밸런서를 사용하기 위해서는 upstream이라는 지시어에 이름을 지어주고 그 안에 서버들의 [호스트:포트]를 적어주어야 합니다.<br>\n(2월 27일 수정 : 기존에 127.0.0.1로 호스트 설정 해주었는데 도커,도커 컴포즈에서 사용하려면 해당 서비스명(web)을 호스트로 지정해주어야 합니다)\n<br>\n그리고 아래의 server 블럭에는 프록시 설정을 해준 것인데,<br>\n80번 포트를 통하여 요청을 보내면 위에서 정해준 upstream 서버들에게 요청을 분배해줍니다.<br>\n<br>\n그 외에는 각 location에 해당하는 경로로 요청을 했을때 alias 경로로 변환하여 찾아주는 설정입니다.<br>\n<br>\n이제 두 서버중 하나가 다운이 되어도 다른 온라인 서버로 연결되어 사용자가 중단없이 사용할 수 있을 것 입니다.<br>\n<br>\n다음 포스팅은 docker-compose를 사용하여 django, gunicorn 컨테이너와 nginx 컨테이너를 연결하는 작업을 할 예정입니다. <br>\n<br>\n부족한 글 읽어주셔서 감사합니다</p>","frontmatter":{"title":"무중단 배포 구축하기 - nginx","date":"2022-02-20, 11:05 pm","description":"nginx 설정하기"}},"previous":{"fields":{"slug":"/post-2/"},"frontmatter":{"title":"django 로딩 속도 개선해보기"}},"next":{"fields":{"slug":"/post-4/"},"frontmatter":{"title":"무중단 배포 구축하기 - docker"}}},"pageContext":{"id":"25573c4d-a8ae-50cf-aa4b-4d2a5a341d04","previousPostId":"94dbd0d7-1642-5284-b0cb-dc4782ad407e","nextPostId":"d0adaccc-39b8-5204-948c-ff8abd7ff381"}},
    "staticQueryHashes": ["2841359383","3257411868"]}